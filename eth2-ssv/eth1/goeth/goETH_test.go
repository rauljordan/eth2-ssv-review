package goeth

import (
	"encoding/hex"
	"github.com/bloxapp/ssv/utils/threshold"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/stretchr/testify/require"
	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"

	"github.com/bloxapp/ssv/eth1"
	"github.com/bloxapp/ssv/shared/params"
	"github.com/bloxapp/ssv/storage/collections"
	"github.com/bloxapp/ssv/storage/kv"
	"github.com/bloxapp/ssv/utils/logex"
)

var skBase64 = "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBN2pXcExremd2TXdvRzhNdEVyUjJEaFQyTXV0SWZhR3RWbEx4NVYraDhqbCt2eXFPClYvcmxKREVlQy9HMzVpV0M0WEU3RnFKUVc1QmpvQWZ1TXhQelFDNnowQTVvUjd6dG5YdTZzRXdOSElIWHdEQUgKTHlTdVdQM3BGYlo0Qnc5b1FZTUJmbVNsL3hXR0syVnN3aVhkQ0VxRkpGZ01QWTc2UlBjSjZHZ2RNZytZVFFZVQpFamlRTjFpdmJKZjRWaUpCRTcrbVNteFZNNTAzVmlyQWZndkJ6cGd1M3N0dkh0elFXVnZ4cnQ1NHRGb0MwdGZYCk1RRXNSU0VtTVRoVkhocVorZTJCOC9kTWQ2R1FodnE5ZXR1RWFCTGhKWkVReWkySWlRTTZSWDZrTW9kZ0ZSZy8KemttTFZXQ0VITzEzaFV5Rkoxang1L0M5bEIyU2VENW9jd1h4YlFJREFRQUJBb0lCQUN3NFhlMndhOC9nZmxtWgpBOWNERlI5TUdPQWUrVmdKR1dwNi8xaTdSZzczU1dZbmVrRXUzRGE1djRBc0lSMWlQVWVvZzNXU01DU3ZTeTg4CkNhWUZ3QlJjRnhrNmMzVk54emFDNzRjbXR4QmhzakdGT1BBeGVRUWdMcExQU3J6VXlWL1ArQWtFbWlRZVZNZmQKampFRVltSFZvNTI1a3B3aTNLYk16VlFOYjg0STUyZEcwRXY4ZnNZbW1COHNDaGVkSVcrdDdjL1c3djFMT2VESwpWZ1FWNUpkSzBOeUtuVFpzdE9qck13eXZoTEcwNGlHVlZUZnJib3EyWk0yYTRZNkJ0V25YN2xCS3BhbWsxWUlKCkpqWlZ5WlowRmR5RlBWTklmVWNVYnVUeGJ3T0p5OE5tMmhsaGNjMlBzbWovQkJSNUFvYVpYcytyRThtcUEyeUkKcUVjZjVvRUNnWUVBOVpNb3RMS0xrL3RSbVFuNTlMbVhxaFlUS1VlMDdHV21ROGR0RlhuZDFBSlhkQ2I4U3BSdgpDTmVGQnhNQkVQZHBtSXdUWG9haURtNzRkNWRPb20xZWlDYTdCcHJ6cFVGM2VGSlBzdXV6ejA0eUVmaGVHRHd0ClZQOXA2RU9HZHlFK0pLR0gxc3BMelgwUkRIUENLUng5VnN1aVl3S0RLbkpSN3dEUTVwVWl5WkVDZ1lFQStGSjEKWkFjOVViSExISDROamJLeHRNL1Fwa3psVGw3bUxWYlpJZHFrMkcraktXbnIrYzJZN2hDQThFQW1tbXlSRGhvQQpOdWMyU08yVWpnY2crUHYvUjc2aHRUV1BGSCszdWd0ZWtZajMvRGdFZllVWEtBUFhYaGdQbnRNMDU2WlZFcHF3CmtzSXVQWGRROE9SRWs1Q2o4SFhPeE9rdEIwL01TZnU5WGRqVlhCMENnWUVBcElnOUhKd0hZbFZldlQ5dTVlVTIKMVRGSEUwQkUycUhjUE1zdnJkVGhwL3NOcHZlN3p5Z1dJSUZ0VW1rTUxOYm5POXFWMjU0dWs2Y0w5K3c3Tmg0NgoyTlBDT05HMmJrRW5qMGp1dHZ5dWt6VmIzS2hnT3JLTzJNVHJxejhhcDFSeGMwOTZXSkZmS2tVaUdBcXl5cUtZCjQzODV4RVpacFNYRStYRzloTS9rNTlFQ2dZQTZXZVlMNDBlZGN0SHZtQTlIUkw1TlpxZjQ3QWpXS2FhYzhOT0YKQ1FQRGVEZzIreFRnVmxlaFdXOXpCU0FOR1lYY2NtK3FkeHBpZUxGM3ptVUpITzRYeGN2cDhQUDJOU3pQSXV6Tgo5Z21QMHZuN0pOTVVMQkxub1cvS09vY3NDQUhscFVQb3VJaDFHUnlEL3ArK3JUWll3dFlibjA5ZGNIcm94NmJ2CjdvdjBZUUtCZ0gwem5Fend6ZEJVWTBBdFh6MUFTQjl1aUN6ZVNnbEZyRWwzR0k4OEEySXgyamFkMEhBR0NteVkKTnJBSVpLTjQ0anAzVjcvZ0IyMm9pQTIyK3VSTEEyMDJnM2RDaVRFYXRVMGY5SjhncDM4VGVrTHAvVmdTcHVpTgpLUm1YOGI5SlpXeGhpQk1OaXMwZjNuQnQ5VkRYN0crdEhJWS81QUNSSEtwNkZMUGhuYWVQCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="
var eventData = "00000000000000000000000067ce5c69260bd819b4e0ad13f4b873074d479811000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000030a65a81195f44fc3a7e3cf3db78db202c35de37b062dfba9582369afbf561ad5fa61517fb6f581f927edf1566ff71dc87000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000b80000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424e32705863457872656d643254586476527a684e64455679556a494b524768554d6b313164456c6d59556430566d784d654456574b326734616d7772646e6c7854315976636d784b5245566c517939484d7a567056304d3057455533526e464b55566331516d707651575a315458685165677052517a5a364d45453162314933656e52755748553263305633546b684a534668335245464954486c54645664514d334247596c6f30516e63356231465a54554a6d62564e734c33685852307379566e4e336156686b436b4e4663555a4b526d644e55466b334e6c4a5159306f325232646b545763725756525257565646616d6c52546a4670646d4a4b5a6a5257615570435254637262564e7465465a4e4e54417a566d6c7951575a6e646b494b656e426e64544e7a64485a496448705256315a3265484a304e545230526d39444d48526d5745315252584e53553056745456526f566b686f63566f725a544a434f43396b545751325231466f646e45355a58523152517068516b786f536c704655586c704d6b6c7055553032556c6732613031765a476447556d6376656d747454465a5851305649547a457a61465635526b6f78616e67314c304d3562454979553256454e57396a64316834436d4a525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030b16980164bb8005ef28343bb754dfe4365193b6c58f76b4fea2229106fe4f46919450b0535a9f4e1539024dbba8ccfe80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000015852436945746e7a2b65422b784b683251654c6250525232714d454e3730697645497642703557552f414859522f57386468577256786134663179356f644e394237706f566170516564306e394e2b7a676c514d777257587865787a3634787137516e46533650572b4774584946652f42764c72386c6675744a376f6d72716335653832517a6359577a383076625a4d575779796c6d62447179356b5079494b537145554755304a6976492f6656485734584f4755473947526453555335566f675a54474c393031462b2b6d754f63516e586c6b4d35314d383047352f49504e696e6b647262657349336235466570434f314d72666c2b63575653766f722b6e384a4e53537853566735724d4166666a59586b45727363665533494d7152324f6e674e425130692f33446637346b486e4d69553157547a6a684e52686f31636261774d412f636f68684b554e4a634252386f57312b30513d3d000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642623370566147467a534739486545315953337055627a67725348634b57475630656e4a7457454e594f546474655842706148686a4c32777853456c6c53565677563256334e6b464e4d7a6c5064314a515a3256564d465a33516d51324e485a68627a5a7354544e615157785464565a6c4d677061626c4e305430314a636b4a5457475673596b633062314272524735785a6b4e4e62474a6d6131524e526c685856466f776445314964474a77566b55334e326f3061457078615549335a553133596974774e585578436c6f764e6d5678576a5a6d5257526e4f4449354d7a4e335a55686856574e7a64325a4a516d68594e6c4e61556a4e6c4d6b4a7652554a3262486c6a4e4535454e45466f4e5646615a6a4d7252577078536974356448594b63336869526d354d4e55704c5757686a536c6334596d7443647a4e6f4d3256726555597959324932655545334d336473547a5a68576b6c6152574a34516b453057446c34576a684d534642614e484a59574739476277706f4d564643643149784f555668656d463562306831546d4a6b574770426255396863315669543074744e464a42646b3979613146775a31493453304a344e474d7a637a6b304f466c696454424a526b745162304e49436b4a335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030a9835847fad080e5b8f929954e4dd8ddc609be40e42989ec919629a38102a3834e752996fef1e1b856e6090d8ee390e10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000015858776166555a2b7a6d564a51316e5874796345587545364d6b39505469664a7a4e4633496f734f346e71413830366e6f2b496b615565624566473068356b304e4a44776a577a364e4832306b6b58455a626558546a3647666e3742562f772f79767632587a35327874326a46506b647275766a39655a69383843666c654b635068756677482b43484c6c675159464b7363354d3472746265544452433855487166586e7541304f664669766869486431655735417734585a70446451765663635a48355747654c5369587132645a7031506173505645656d7336704b73636c5a756d4630334c50496339636433594b643445513465714b654a412b577156516d57396432436e71544d4a705a39544b4d6a70315867685077635749326255495062506141513165506e62316d34387062687a5653714255596d674b4a5a684f4a546279386d626667762b756238793039362b673146513d3d000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642636a5a586330396b4d7a4a5a5653745065566f7756565a74556c594b516b68455245744c4d3255314f545270557a56326448524c4d564a694d6c5659643359774e475a4b634764344c314e51576d6c71556d45306546646d63335a7361544d7865486731633273724d6c68364f544a3156516f35546c45344f47526c4c305978656d4a74616e51774d323577576a686153323533636d314c4f585a55524539505a4659344d3152694d554e59547a466862334a3265564d314d4552695a546c536248453253474e44436e567554545261516e6b30534864765a3270425a6a5932595446436330383565477832526a63305545677252544a3051316b305a5659774c314d3456466448626a6834523064495457354754306c31556d524d5554414b656d4d7651307050566a42494b316461534556455a5463794e5538775231417754585630516d4e485a57453152334134636b5a7757486b764d444642646d6c58616a426e4d4464714d4652314d30685a4e30646c53776f765a564e544c3168574f474a55524734344d305a516245353457486479566d6c33637a6c306347787a54464d78655578534e30787854324e5959566c344e48524c59334672565451305546686d656d395565433942436d68335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000308f49c4bf4be1f728c0a83840a44f7949b7284fc39dcfeef654c9e6bfd63f549d994eceacdf754d801e44871a7dd0224e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001586556356e2b4a737546395934773754717a476b4b68434470485761647232644f78513865784e517259736b6875324e636f2b5872366b65614556587168776d724d4d317370577067714f3667346a3433546c4a4f55724f6141774274625a6f6d4372396d75756846464e71454870752f596e765a672b4143466b44556472556b5032346262456c546c6a6b3461365065445734463778526a2b566952415234677541724d48384a7838332b4e6574475271556b694a6579566973574e4c6933594d557371674c6131486a5553526437722b322b4339416f4734346f644b6548764a2f7951656878784d7471646643444446387244767454646b425630434f63554e7a6a714b546a2f475869372b42466b482b6d325661543364556367775a3853496834457a79415066622f2f74744649493743426258452f4d625a7263765971414e5278682f375a38633345667556394c79372f7a773d3d000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556426456497a5630686d55316c68576c45304e6a6b78656e52306154594b5a6c4242634578716132394c6379737251533930515764535658644862456858596d35694e6a4a5056553472613074545555353356576c4e4d4652775747644f564856534e47706a6457644b61314e54526c5253524170355745777653585270627a6c465a48453361456852513342455130784356464e59526c4e744d6a4a724e6c4e52626c6c476557733355564e6e646e6f795157396d4f584a3659566442516d566d556b5a5064557335436e465754303072627a686e526e467763586c51526e524a527939435653394662316c324d30464e5531413555574a4354585258536b4976635464325153745a4d5546725a454a6959554e756147466b4b3146555747774b5931566b537a526162485a314e566446576b784c6443394f4d6c5531524751776146683452584275526c6f334c3031534e56526e52566c324e466c336155704865574e795254464b5747565355324d724d3231445751704b656b567a596a4a50575442545a453833596a424d635764714d326856613052746345645653324e6f516c5179614777304e574a35616b3476616c5a6a555731726232396c5955677a53437432523249764e7a6856436b56335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000308ac570c4a0ffaf441fcaf20f51e632ce5f1b12df05eaa0456e4fda5f208b256b56062912a0086cb577ee1016e200a9990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001584a7538706c567a736777686b4d59734d31362f6e4b564d3875557556713856794a6859344a7a5a54564f74467a667570514c4d2f624c59427647646f525272676f37446e554972687854683350486e6c524774436f4c696662506c2f33335862556d546772315166396a51797a576e69565a76396374435a764e76505353727330414a5537395031784877486743564d53434376384b794a585277334f6d4e304e736a5363446c6a626c493844634b586a5859475570464f6d613742344b4158344f564c547366336a7158727a46582b3365346568626e7052794d3577572b57755a2b617a6443594a726a35485454694955423875666c415839593943316b715438576163476e4970313930597177623462624e6645726e6e623259623259484b3549317658634d326f6177544a3977567963787465424e46364364347833506773396d3759674e4d2b30776b3479626e6765654f773d3d0000000000000000"

type EventObserver struct {
	t    *testing.T
	data eth1.ValidatorAddedEvent
}

func (e *EventObserver) InformObserver(i interface{}) {
	validatorAddedEvent, ok := i.(eth1.ValidatorAddedEvent)
	require.True(e.t, ok)
	e.data = validatorAddedEvent
}

func (e *EventObserver) GetObserverID() string {
	return "id"
}

func TestAddValidatorEventEndToEnd(t *testing.T) {
	threshold.Init()

	logger := *zap.L()
	db, err := kv.New("./data/db", logger, &kv.Options{InMemory: true})
	require.NoError(t, err)
	defer db.Close()
	operatorStorage := collections.NewOperatorStorage(db, &logger)
	require.NoError(t, operatorStorage.SetupPrivateKey(skBase64))
	validatorStorage := collections.NewValidatorStorage(db, &logger)

	contractAbi, err := abi.JSON(strings.NewReader(params.SsvConfig().ContractABI))
	require.NoError(t, err)
	e := &eth1GRPC{
		ctx:             nil,
		conn:            nil,
		logger:          logex.Build("SSV-CLI", zapcore.DebugLevel),
		contractEvent:   eth1.NewContractEvent("smartContractEvent"),
		operatorStorage: operatorStorage,
	}

	observer := EventObserver{t: t}
	e.GetContractEvent().Register(&observer)

	t.Run("processAddValidatorEvent", func(t *testing.T) {
		data, err := hex.DecodeString(eventData)
		require.NoError(t, err)
		err = e.ProcessValidatorAddedEvent(data, contractAbi, "ValidatorAdded")
		require.NoError(t, err)
		require.NotNil(t, observer.data)
	})

	t.Run("validatorStorageInformAddValidator", func(t *testing.T) {
		validatorStorage.InformObserver(observer.data)
		share, err := validatorStorage.GetValidatorsShare(observer.data.PublicKey)
		require.NoError(t, err)
		require.Equal(t, "0d140b18e66e6c4ca60b987e0652135160a150f329ee6cf4c0e47a3db07ab769", share.ShareKey.SerializeToHexStr())
		require.Equal(t, "b16980164bb8005ef28343bb754dfe4365193b6c58f76b4fea2229106fe4f46919450b0535a9f4e1539024dbba8ccfe8", share.ShareKey.GetPublicKey().SerializeToHexStr())
	})
}

//func TestAddValidatorEvent(t *testing.T) {
//	t.Run("add", func(t *testing.T) {
//		threshold.Init()
//
//		logger := *zap.L()
//		db, err := kv.New("./data/db", logger, &kv.Options{InMemory: true})
//		require.NoError(t, err)
//		defer db.Close()
//		operatorStorage := collections.NewOperatorStorage(db, &logger)
//		validatorStorage := collections.NewValidatorStorage(db, &logger)
//
//		client, err := ethclient.Dial("ws://eth1-ws.stage.bloxinfra.com/ws")
//		require.NoError(t, err)
//
//		contractAddress := common.HexToAddress("0x9640256dc8b8ae0be84b1a2885277bc4f26869d7")
//		query := ethereum.FilterQuery{
//			FromBlock: big.NewInt(4825778),
//			ToBlock:   big.NewInt(4825778),
//			Addresses: []common.Address{
//				contractAddress,
//			},
//		}
//
//		logs, err := client.FilterLogs(context.Background(), query)
//		require.NoError(t, err)
//
//		contractAbi, err := abi.JSON(strings.NewReader(params.SsvConfig().ContractABI))
//		require.NoError(t, err)
//
//		require.NoError(t, operatorStorage.SetupPrivateKey(skBase64))
//		sk, err := operatorStorage.GetPrivateKey()
//		operatorPublicKey, err := rsaencryption.ExtractPublicKey(sk)
//
//		for _, vLog := range logs {
//			fmt.Println("TEST:     ", hex.EncodeToString(vLog.Data))
//			fmt.Println("BlockNumber:     ", vLog.BlockNumber)
//			fmt.Println("TxHash:          ", vLog.TxHash.Hex())
//
//			fmt.Println(hex.EncodeToString(vLog.Data))
//
//			eventType, err := contractAbi.EventByID(vLog.Topics[0])
//			require.NoError(t, err)
//
//			event := eth1.ValidatorAddedEvent{}
//			err = contractAbi.UnpackIntoInterface(&event, eventType.Name, vLog.Data)
//			require.NoError(t, err)
//
//			fmt.Println("Validator PubKey:", hex.EncodeToString(event.PublicKey))
//			fmt.Println("Owner Address:   ", event.OwnerAddress.String())
//
//			ibftCommittee := map[uint64]*proto.Node{}
//			validatorShare := collections.ValidatorShare{}
//			for i := range event.OessList {
//				oess := &event.OessList[i]
//				fmt.Println("Index:           ", oess.Index)
//				fmt.Println("Operator PubKey: ", hex.EncodeToString(oess.OperatorPublicKey))
//				fmt.Println("Share PubKey:    ", hex.EncodeToString(oess.SharedPublicKey))
//				fmt.Println("Encrypted Key:   ", hex.EncodeToString(oess.EncryptedKey))
//
//				def := `[{ "name" : "method", "type": "function", "outputs": [{"type": "string"}]}]`
//				outAbi, err := abi.JSON(strings.NewReader(def))
//				if err != nil {
//					logger.Error("failed to define ABI", zap.Error(err))
//					continue
//				}
//
//				outOperatorPublicKey, err := outAbi.Unpack("method", oess.OperatorPublicKey)
//				if err != nil {
//					logger.Error("failed to unpack OperatorPublicKey", zap.Error(err))
//					continue
//				}
//				nodeID := oess.Index.Uint64() + 1
//				ibftCommittee[nodeID] = &proto.Node{
//					IbftId: nodeID,
//					Pk:     oess.SharedPublicKey,
//				}
//
//				if oessOperatorPublicKey, ok := outOperatorPublicKey[0].(string); ok {
//					oess.OperatorPublicKey = []byte(oessOperatorPublicKey)
//
//					// mock pubsub functionality
//					data, _ := json.Marshal(event)
//					var eventFromObserver eth1.ValidatorAddedEvent
//					require.NoError(t, json.Unmarshal(data, &eventFromObserver))
//
//					oess2 := eventFromObserver.OessList[i]
//					if strings.EqualFold(string(oess2.OperatorPublicKey), operatorPublicKey) {
//						out, err := outAbi.Unpack("method", oess2.EncryptedKey)
//						if err != nil {
//							logger.Error("failed to unpack EncryptedKey", zap.Error(err))
//							continue
//						}
//
//						if encryptedSharePrivateKey, ok := out[0].(string); ok {
//							decryptedSharePrivateKey, err := rsaencryption.DecodeKey(sk, encryptedSharePrivateKey)
//							if err != nil {
//								logger.Error("failed to decrypt share private key", zap.Error(err))
//								continue
//							}
//							decryptedSharePrivateKey = strings.Replace(decryptedSharePrivateKey, "0x", "", 1)
//
//							oess2.EncryptedKey = []byte(decryptedSharePrivateKey)
//							validatorShare.NodeID = nodeID
//
//							validatorShare.ValidatorPK = &bls.PublicKey{}
//							if err := validatorShare.ValidatorPK.Deserialize(event.PublicKey); err != nil {
//								logger.Error("failed to deserialize share public key", zap.Error(err))
//								return
//							}
//
//							validatorShare.ShareKey = &bls.SecretKey{}
//							if err := validatorShare.ShareKey.SetHexString(string(oess2.EncryptedKey)); err != nil {
//								logger.Error("failed to deserialize share private key", zap.Error(err))
//								return
//							}
//
//							ibftCommittee[nodeID].Sk = validatorShare.ShareKey.Serialize()
//						}
//					}
//
//				}
//
//				eventSignature := []byte("ItemSet(bytes32,bytes32)")
//				hash := crypto.Keccak256Hash(eventSignature)
//				fmt.Println(hash.Hex()) // 0xe79e73da417710ae99aa2088575580a60415d359acfad9cdd3382d59c80281d4
//			}
//
//			validatorShare.Committee = ibftCommittee
//			require.NoError(t, validatorStorage.SaveValidatorShare(&validatorShare))
//			v, err := validatorStorage.GetValidatorsShare(event.PublicKey)
//			require.NoError(t, err)
//			require.NotNil(t, v)
//
//			marshalValidatorShare, err := json.Marshal(&validatorShare)
//			if err != nil {
//				logger.Error("failed to marshal validator share", zap.Error(err))
//				return
//			}
//
//			var validatorShare2 collections.ValidatorShare
//			err = json.Unmarshal(marshalValidatorShare, &validatorShare2)
//			if err != nil {
//				logger.Error("failed to unmarshal validator share", zap.Error(err))
//			}
//
//			fmt.Println("TEST2:   ", validatorShare2.ValidatorPK.SerializeToHexStr())
//		}
//	})
//}
